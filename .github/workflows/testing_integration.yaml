name: Integration Tests

on:
  workflow_dispatch:
env:
  WANDB_MODE: offline
  WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
  ZETTA_USER: github-ci
  ZETTA_PROJECT: zetta-research
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #SETUPTOOLS_ENABLE_FEATURES: legacy-editable

jobs:
  pytest:
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        os:
          - ubuntu-latest
        python-version:
          - "3.11"
          - "3.12"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Get token from Github App
        uses: actions/create-github-app-token@v1
        id: app_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PEM }}
          # owner is required, otherwise the creds will fail the checkout step
          owner: ${{ github.repository_owner }}
      - name: Checkout from GitHub
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: true
          ssh-key: ${{ secrets.git_ssh_key  }}
          token: ${{ steps.app_token.outputs.token }}
      - name: Free up disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          df -h
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64
          cache: 'pip'
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.18.4'
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true
          token_format: 'access_token'
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-east1-docker.pkg.dev,us-central1-docker.pkg.dev
      - name: Build and push Docker image
        run: |
          python build_image.py \
            --project zetta-research \
            --tag_suffix github_action_integration_test \
            --mode all_pcg \
            --region us-east1 \
            --python ${{ matrix.python-version }}
      - name: Clean up Docker images
        run: |
          # Remove the built image and all intermediate layers
          docker image rm us-east1-docker.pkg.dev/zetta-research/zutils/zetta_utils:py${{ matrix.python-version }}_github_action_integration_test || true
          # Prune all dangling images, build cache, and unused images
          docker system prune -af --volumes
          df -h
      - name: Install CUE
        run: go install cuelang.org/go/cmd/cue@v0.6.0
      - name: Install libboost
        run: sudo apt install libboost-dev
      - name: Install Python dependencies
        run: |
          python install_zutils.py --mode=all --dockerfile --skip_apt
      - name: Run pytest
        run: cd tests/integration && coverage run -m pytest --run-integration .
        shell: bash -l {0}
      - name: Send coverage repot to codecov
        uses: codecov/codecov-action@v3
        with:
          files: /home/runner/work/zetta_utils/zetta_utils/coverage_integration.xml
